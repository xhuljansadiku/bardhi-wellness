 <!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout – Bardhi Wellness</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="./assets/css/checkout.css"/>
</head>
<body class="bg-soft">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top bg-white border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">
      <i class="bi bi-activity text-brand me-2"></i>Bardhi Wellness
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
        <li class="nav-item"><a class="nav-link" href="transformation.html">Transformime</a></li>
        <li class="nav-item"><a class="nav-link" href="pricing.html">Paketat</a></li>
        <li class="nav-item"><a class="nav-link" href="contact.html">Kontakt</a></li>
        <li class="nav-item"><a class="btn btn-sm btn-outline-dark ms-lg-2" href="login.html">Login</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container py-4 py-lg-5">

  <div class="row g-4">
    <!-- Kolona majtas (pjesa që ndryshon sipas hapit) -->
    <div class="col-lg-8">

      <!-- === HAPI 1: SHPORTA === -->
      <section id="stepCart" class="card border-0 shadow-soft rounded-2xl">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="bi bi-bag-check me-2 text-brand"></i>Shporta</h4>
            <a href="index.html#pricing" class="btn btn-sm btn-outline-secondary">Vazhdo blerjet</a>
          </div>

          <div id="cartList" class="cart-list"></div>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="small text-muted"><i class="bi bi-info-circle me-1"></i>Nëse ka abonim, do të faturohet çdo muaj.</div>
            <button class="btn btn-brand" id="goDetails">Vazhdo</button>
          </div>
        </div>
      </section>

      <!-- === HAPI 2: TË DHËNAT + PAGESA === -->
      <section id="stepDetails" class="card border-0 shadow-soft rounded-2xl d-none">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="bi bi-person-vcard me-2 text-brand"></i>Të dhënat e blerësit</h4>
            <button class="btn btn-sm btn-outline-secondary" id="backToCart"><i class="bi bi-arrow-left"></i> Mbrapa</button>
          </div>

          <form id="buyerForm" novalidate class="mb-4">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Emri</label>
                <input type="text" class="form-control" id="name" required />
                <div class="invalid-feedback">Shkruaj emrin.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email <span class="text-danger">*</span></label>
                <input type="email" class="form-control" id="email" required />
                <div class="invalid-feedback">Shkruaj email të vlefshëm.</div>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="createAccount">
                  <label class="form-check-label" for="createAccount">Dua të krijoj llogari pas pagesës</label>
                </div>
              </div>
            </div>
          </form>

          <h5 class="mb-3"><i class="bi bi-credit-card-2-front me-2 text-brand"></i>Mënyra e pagesës</h5>
          <ul class="nav nav-pills mb-3" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabCard">
                <i class="bi bi-credit-card me-1"></i>Kartë (Stripe)
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabPP">
                <i class="bi bi-paypal me-1"></i>PayPal
              </button>
            </li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="tabCard">
              <div class="alert alert-secondary">Kur shtypet <strong>Paguaj me kartë</strong> krijohet <code>/api/checkout/session</code> dhe ridrejtohesh te Stripe Checkout.</div>
              <button class="btn btn-brand w-100" id="payStripe"><i class="bi bi-lock-fill me-2"></i>Paguaj me kartë</button>
            </div>
            <div class="tab-pane fade" id="tabPP">
              <div class="alert alert-secondary">Butonat PayPal inicializohen përmes JS SDK (placeholder).</div>
              <button class="btn btn-outline-dark w-100" id="payPayPal">Vazhdo me PayPal</button>
            </div>
          </div>
        </div>
      </section>

    </div>

    <!-- Kolona djathtas – Përmbledhja (qëndron gjatë të dy hapave) -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-soft rounded-2xl">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Përmbledhje</h5>
            <span class="badge badge-plan" id="badgeType">Pagesë njëherë</span>
          </div>

          <ul id="summaryLines" class="list-group list-group-flush mb-3"></ul>

          <ul class="list-group list-group-flush mb-3">
            <li class="list-group-item d-flex justify-content-between">
              <span class="fw-semibold">Nëntotali</span>
              <span>€<span id="subtotal">0</span></span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Ulje kuponi</span>
              <span>−€<span id="discount">0</span></span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>TVSH</span>
              <span>€<span id="tax">0</span></span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span class="fw-semibold">Totali</span>
              <span class="fs-5 fw-bold">€<span id="total">0</span></span>
            </li>
          </ul>

          <div class="mb-3">
            <label class="form-label">Kupon (opsional)</label>
            <div class="input-group">
              <input type="text" class="form-control" id="coupon" placeholder="p.sh. WELCOME10"/>
              <button class="btn btn-outline-secondary" id="applyCoupon">Apliko</button>
            </div>
            <div id="couponMsg" class="form-text"></div>
          </div>

          <div class="mb-2">
            <label class="form-label">Numri i TVSH-së (opsional)</label>
            <input type="text" class="form-control" id="vat" placeholder="p.sh. AL12345678"/>
          </div>

          <div class="small text-muted"><i class="bi bi-shield-check me-1"></i>Pagesa përpunohet nga ofrues të çertifikuar.</div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ---------------- Helpers ---------------- */
const money = (v,c='EUR') => new Intl.NumberFormat('sq-AL',{style:'currency',currency:c}).format(v);
const readCart  = () => { try { return JSON.parse(localStorage.getItem('cart')||'{"items":[]}'); } catch { return {items:[]} } };
const writeCart = (c) => localStorage.setItem('cart', JSON.stringify(c));

let cart = readCart();

/* ---------------- Render ---------------- */
function renderCart() {
  const wrap = document.getElementById('cartList');
  if (!cart.items.length) {
    wrap.innerHTML = `<div class="text-center text-muted py-4">Shporta bosh. <a href="index.html#pricing">Shto artikuj</a>.</div>`;
    return;
  }
  wrap.innerHTML = '';
  cart.items.forEach((it, idx) => {
    const row = document.createElement('div');
    row.className = 'cart-row';
    row.innerHTML = `
      <img class="cart-thumb" src="${it.image||'assets/images/pako.jpg'}" alt="">
      <div class="cart-info">
        <div class="title">${it.title}</div>
        <div class="meta">${it.mode==='sub' ? money(it.price,it.currency)+' /muaj' : money(it.price,it.currency)}</div>
      </div>
      <div class="cart-ctrl">
        <div class="qty">
          <button class="btn-minus" aria-label="−">−</button>
          <input type="number" min="1" value="${it.qty||1}">
          <button class="btn-plus" aria-label="+">+</button>
        </div>
        <button class="x-btn" aria-label="Hiq"><i class="bi bi-x-lg"></i></button>
      </div>
    `;
    const minus = row.querySelector('.btn-minus');
    const plus  = row.querySelector('.btn-plus');
    const input = row.querySelector('input');
    minus.onclick = ()=>{ input.value=Math.max(1,(+input.value||1)-1); it.qty=+input.value; persist();};
    plus.onclick  = ()=>{ input.value=(+input.value||1)+1; it.qty=+input.value; persist();};
    input.oninput = ()=>{ it.qty=Math.max(1,(+input.value||1)); persist();};
    row.querySelector('.x-btn').onclick = ()=>{ cart.items.splice(idx,1); persist();};
    wrap.appendChild(row);
  });
}

function renderSummary(){
  const lines = document.getElementById('summaryLines');
  lines.innerHTML = '';
  let subtotal = 0, hasSub = false;
  (cart.items||[]).forEach(it=>{
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between';
    const lineTotal = (it.qty||1)*it.price;
    subtotal += lineTotal;
    hasSub = hasSub || it.mode==='sub';
    li.innerHTML = `<span>${it.title} <span class="text-muted small">× ${it.qty||1}</span></span><span>${money(lineTotal,it.currency||'EUR')}</span>`;
    lines.appendChild(li);
  });
  document.getElementById('badgeType').textContent = hasSub ? 'Ka abonim' : 'Pagesë njëherë';
  document.getElementById('subtotal').textContent = subtotal.toFixed(0);
  const discount = +document.getElementById('discount').textContent || 0;
  const tax = +document.getElementById('tax').textContent || 0;
  document.getElementById('total').textContent = Math.max(0, subtotal - discount + tax).toFixed(0);
}

function persist(){ cart.updatedAt=Date.now(); writeCart(cart); renderCart(); renderSummary(); }

/* ---------------- Coupon demo ---------------- */
document.getElementById('applyCoupon').addEventListener('click', ()=>{
  const c = document.getElementById('coupon').value.trim().toUpperCase();
  const msg = document.getElementById('couponMsg');
  let d = 0;
  if (c==='WELCOME10'){ d=10; msg.textContent='Kuponi u aplikua.'; }
  else if(c){ msg.textContent='Kupon i pavlefshëm.'; }
  else { msg.textContent=''; }
  document.getElementById('discount').textContent = d.toFixed(0);
  renderSummary();
});

/* ---------------- Steps ---------------- */
const stepCart = document.getElementById('stepCart');
const stepDetails = document.getElementById('stepDetails');

document.getElementById('goDetails').addEventListener('click', ()=>{
  if (!cart.items.length) { alert('Shporta bosh.'); return; }
  stepCart.classList.add('d-none');
  stepDetails.classList.remove('d-none');
  window.scrollTo({top:0, behavior:'smooth'});
});

document.getElementById('backToCart').addEventListener('click', ()=>{
  stepDetails.classList.add('d-none');
  stepCart.classList.remove('d-none');
  window.scrollTo({top:0, behavior:'smooth'});
});

/* ---------------- Payments (payload demo) ---------------- */
async function startStripe(){
  const form = document.getElementById('buyerForm');
  if(!form.checkValidity()){ form.classList.add('was-validated'); return; }
  const hasSub = cart.items.some(i=>i.mode==='sub');
  const payload = {
    provider:'stripe',
    mode: hasSub ? 'subscription' : 'payment',
    email: document.getElementById('email').value,
    items: cart.items.map(i=>({
      type:i.type, sku:i.sku, title:i.title, qty:i.qty||1,
      unit_price: Math.round(i.price*100), currency:i.currency||'EUR', mode:i.mode
    })),
    coupon: document.getElementById('coupon').value || undefined,
    vat: document.getElementById('vat').value || undefined
  };
  try{ localStorage.setItem('buyerEmail', payload.email);}catch(e){}
  const res = await fetch('/api/checkout/session',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
                   .then(r=>r.json()).catch(()=>({}));
  if(res && res.url){ location.href = res.url; }
  else { alert('S’mundu të krijohej seanca e pagesës.'); }
}
async function startPayPal(){
  const form = document.getElementById('buyerForm');
  if(!form.checkValidity()){ form.classList.add('was-validated'); return; }
  const hasSub = cart.items.some(i=>i.mode==='sub');
  const res = await fetch('/api/checkout/session',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({provider:'paypal',mode:hasSub?'subscription':'payment'})})
                   .then(r=>r.json()).catch(()=>({}));
  if(res && res.approveUrl){ location.href = res.approveUrl; }
  else { alert('S’mundu të krijohej porosia PayPal.'); }
}
document.getElementById('payStripe').addEventListener('click', startStripe);
document.getElementById('payPayPal').addEventListener('click', startPayPal);

/* ---------------- Init ---------------- */
renderCart(); renderSummary();
</script>
</body>
</html>
